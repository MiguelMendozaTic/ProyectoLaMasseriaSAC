name: CI Pipeline - Punto 3

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
      
      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Cachear dependencias de Maven
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Compilar el proyecto
        run: mvn clean compile
      
      - name: Ejecutar pruebas con Maven
        run: mvn test
        continue-on-error: true
      
      - name: Verificar y preparar reportes de pruebas
        if: always()
        run: |
          # Verificar si existen reportes de pruebas
          if [ -d "target/surefire-reports" ]; then
            echo "Reportes encontrados en target/surefire-reports/"
            mkdir -p test-reports/surefire
            cp -r target/surefire-reports/* test-reports/surefire/ 2>/dev/null || true
            echo "Reportes de surefire copiados"
          else
            echo "No se encontraron reportes en target/surefire-reports/"
          fi
          
          # Verificar si existen reportes de pruebas de Spring Boot
          if [ -d "target/test-results" ]; then
            echo "Reportes adicionales encontrados en target/test-results/"
            mkdir -p test-reports/spring
            cp -r target/test-results/* test-reports/spring/ 2>/dev/null || true
            echo "Reportes de Spring copiados"
          fi
          
          # Crear archivo de resumen
          mkdir -p test-reports/summary
          echo "Proyecto: Proyecto Masseria (Spring Boot)" > test-reports/summary/info.txt
          echo "Fecha: $(date)" >> test-reports/summary/info.txt
          echo "Java: 21" >> test-reports/summary/info.txt
          echo "Spring Boot: 3.5.10" >> test-reports/summary/info.txt
          
          # Buscar clases de prueba en el proyecto
          if [ -d "src/test/java" ]; then
            echo "Estructura de pruebas encontrada:" >> test-reports/summary/info.txt
            find src/test/java -name "*.java" | head -10 >> test-reports/summary/info.txt 2>/dev/null || true
          else
            echo "No hay directorio src/test/java - El proyecto no tiene pruebas" >> test-reports/summary/info.txt
          fi
      
      - name: Subir artefactos de pruebas
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-masseria
          path: test-reports/
          if-no-files-found: warn